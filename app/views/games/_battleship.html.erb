<div class="battleship-game" data-game-target="battleshipBoard">
  <% player_key = current_player == game.player1 ? 'player1' : 'player2' %>
  <% opponent_key = current_player == game.player1 ? 'player2' : 'player1' %>
  <% phase = game.state['phase'] %>
  <% my_ready = game.state["#{player_key}_ready"] %>
  <% my_board = game.state["#{player_key}_board"] || [] %>
  <% my_shots = game.state["#{player_key}_shots"] || [] %>
  <% my_ships = game.state["#{player_key}_ships"] || {} %>

  <% if phase == 'placement' %>
    <div class="battleship-placement">
      <h3>–†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π</h3>
      <% unless my_ready %>
        <div class="ships-dock" data-game-target="shipsDock">
          <p class="dock-hint">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–æ—Ä–∞–±–ª–∏ –Ω–∞ –ø–æ–ª–µ. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ - —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å.</p>
          <div class="dock-ships">
            <% BattleshipService::SHIPS.each do |ship_type, length| %>
              <% placed = my_ships.key?(ship_type) %>
              <% ship_name = case ship_type
                             when 'battleship' then '–õ–∏–Ω–∫–æ—Ä'
                             when /cruiser/ then '–ö—Ä–µ–π—Å–µ—Ä'
                             when /destroyer/ then '–≠—Å–º–∏–Ω–µ—Ü'
                             when /submarine/ then '–ü–æ–¥–ª–æ–¥–∫–∞'
                             else ship_type.capitalize
                             end %>
              <div class="draggable-ship <%= 'placed' if placed %>" 
                   data-ship-type="<%= ship_type %>" 
                   data-ship-length="<%= length %>"
                   data-horizontal="true"
                   draggable="true"
                   data-action="dragstart->game#dragStart dragend->game#dragEnd dblclick->game#rotateShipDock">
                <div class="ship-info">
                  <span class="ship-name"><%= ship_name %></span>
                  <span class="ship-size">(<%= length %>)</span>
                </div>
                <div class="ship-visual" data-length="<%= length %>">
                  <% length.times do %>
                    <div class="ship-cell"></div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        <div class="placement-controls">
          <% if my_ships.keys.sort == BattleshipService::SHIPS.keys.sort %>
            <button class="btn btn-primary" data-action="click->game#markReady">–ì–æ—Ç–æ–≤ –∫ –±–æ—é!</button>
          <% else %>
            <p class="ships-remaining">–û—Å—Ç–∞–ª–æ—Å—å —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å: <%= BattleshipService::SHIPS.size - my_ships.size %> –∫–æ—Ä–∞–±–ª–µ–π</p>
          <% end %>
        </div>
      <% else %>
        <p class="ready-status">‚úÖ –í—ã –≥–æ—Ç–æ–≤—ã! –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...</p>
      <% end %>

      <div class="my-board-container">
        <h4>–í–∞—à–µ –ø–æ–ª–µ</h4>
        <div class="battleship-board my-board">
          <div class="board-header">
            <div class="corner"></div>
            <% ('A'..'J').each do |col| %>
              <div class="col-label"><%= col %></div>
            <% end %>
          </div>
          <% 10.times do |row| %>
            <div class="board-row">
              <div class="row-label"><%= row + 1 %></div>
              <% 10.times do |col| %>
                <% cell = my_board[row]&.at(col) %>
                <div class="board-cell <%= 'has-ship' if cell %>" 
                     data-row="<%= row %>" 
                     data-col="<%= col %>"
                     data-action="drop->game#placeShipCell dragover->game#allowDrop dragleave->game#removeDrop">
                  <% if cell %><span class="ship-marker">üö¢</span><% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% elsif phase == 'battle' %>
    <div class="battleship-battle">
      <div class="boards-container">
        <div class="board-section">
          <h4>–í–∞—à–µ –ø–æ–ª–µ</h4>
          <div class="battleship-board my-board">
            <div class="board-header">
              <div class="corner"></div>
              <% ('A'..'J').each do |col| %>
                <div class="col-label"><%= col %></div>
              <% end %>
            </div>
            <% opponent_shots = game.state["#{opponent_key}_shots"] || [] %>
            <% 10.times do |row| %>
              <div class="board-row">
                <div class="row-label"><%= row + 1 %></div>
                <% 10.times do |col| %>
                  <% cell = my_board[row]&.at(col) %>
                  <% shot = opponent_shots[row]&.at(col) %>
                  <div class="board-cell <%= 'has-ship' if cell %> <%= shot %>">
                    <% if shot == 'hit' %>üí•
                    <% elsif shot == 'miss' %>üí®
                    <% elsif cell %>üö¢
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="board-section">
          <h4>–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</h4>
          <div class="battleship-board enemy-board">
            <div class="board-header">
              <div class="corner"></div>
              <% ('A'..'J').each do |col| %>
                <div class="col-label"><%= col %></div>
              <% end %>
            </div>
            <% 10.times do |row| %>
              <div class="board-row">
                <div class="row-label"><%= row + 1 %></div>
                <% 10.times do |col| %>
                  <% shot = my_shots[row]&.at(col) %>
                  <div class="board-cell <%= shot %> <%= 'clickable' if game.playing? && game.current_turn == current_player && !shot %>" 
                       data-row="<%= row %>" 
                       data-col="<%= col %>"
                       data-action="click->game#shootCell">
                    <% if shot == 'hit' %>üí•
                    <% elsif shot == 'miss' %>üí®
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
